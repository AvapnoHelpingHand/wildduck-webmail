</div> <!-- container -->

<div class="webmail-container">
    <div class="sidebar">

        <img src="/images/duck.png" class="img-responsive" style="display: block; margin: 10px auto;">

        <ul class="nav nav-sidebar">
            {{#each mailboxes}}
                <li {{#if selected}} class="active" {{/if}}><a href="/webmail/{{id}}">{{index}}. {{path}}{{#if unseen}} <span class="badge">{{unseen}}</span>{{/if}}</a></li>
            {{/each}}
        </ul>
    </div>
    <div class="webmail-main">

        <h2 class="sub-header">
        <div class="pull-right">
            <a class="btn btn-info btn-sm" href="/webmail/{{mailbox.id}}/audit/{{message.id}}"><span class="glyphicon glyphicon-zoom-in" aria-hidden="true"></span> Logs</a>
            <a class="btn btn-success btn-sm" href="/webmail/{{mailbox.id}}/raw/{{message.id}}.eml" role="button" download="{{message.id}}.eml"><span class="glyphicon glyphicon-cloud-download" aria-hidden="true"></span> Raw source</a>
        </div>

        <span class="glyphicon glyphicon-comment" aria-hidden="true"></span> {{message.subject}}</h2>

        {{#if message.encrypted}}
            <div class="alert alert-warning" role="alert">
                <span class="glyphicon glyphicon-lock" aria-hidden="true"></span>
                This message is encrypted and can not be properly displayed. Download the original message <a href="/webmail/{{mailbox.id}}/raw/{{message.id}}.eml" role="button" download="{{message.id}}.eml" class="alert-link">from here </a> to open it in an e-mail client that is able to read encrypted messages.
            </div>
        {{/if}}

        <div class="table-responsive">
            <table class="table">
                {{#each message.info}}
                    <tr>
                        <td>
                            {{key}}
                        </td>
                        <th {{#if isDate}} class="datestring" title="{{value}}" {{/if}}>
                            {{#if isHtml}}{{{value}}}{{else}}{{value}}{{/if}}
                        </th>
                    </tr>
                {{/each}}
            </table>
        </div>

        <div id="message" class="iframe-box"></div>

        {{#if message.attachments}}
            <div class="well">
                {{#each message.attachments}}
                    <a class="btn btn-success btn-sm" href="/webmail/{{../mailbox.id}}/attachment/{{../message.id}}/{{id}}" role="button" download="{{filename}}"><span class="glyphicon glyphicon-cloud-download" aria-hidden="true"></span> {{filename}}</a>
                {{/each}}
            </div>
        {{/if}}

        <p>
            &nbsp;
        </p>

        <script type="text/javascript" src="/purify-0.9.0/purify.min.js"></script>
        <script>
            var message = {{{messageJson}}};

            document.addEventListener("DOMContentLoaded", function(event) {
                if (message.html) {
                    var clean = DOMPurify.sanitize(message.html.join('\n'), {
                        ALLOW_UNKNOWN_PROTOCOLS: true,
                        WHOLE_DOCUMENT: true,
                        FORBID_TAGS: ['form']
                    });

                    clean = clean.replace(/head>/, 'head><link rel="stylesheet" href="/css/mail.css" /><base target="_parent"><script>function resizeIframe(obj) {obj.style.height = obj.contentWindow.document.body.scrollHeight + "px";}</'+'script>');

                    var iframe = document.createElement('iframe');

                    document.getElementById('message').appendChild(iframe);
                    iframe.contentWindow.document.open();
                    iframe.contentWindow.document.write(clean);
                    iframe.contentWindow.document.close();
                    iframe.contentWindow.addEventListener('load', function(){
                        iframe.contentWindow.resizeIframe(iframe);
                    });
                }
            }, false);
        </script>

    </div>
</div>
<div class="container"><!-- container -->
